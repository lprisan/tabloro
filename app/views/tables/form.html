  {% extends '../layouts/default.html' %}

{% block main %}
  <h1>{{ title }}</h1>
{% endblock %}

{% block content %}
  {% if table.isNew %}
    {% set action = '/tables' %}
  {% else %}
    {% set action = '/tables/' + table.title %}
  {% endif %}

  <div class="about"></div>


  <section class="bg">

    <div class="row container">
      <div class="col-md-12">
        <form method="post" action="{{ action }}" role="form" class="form-horizontal">

          <input type="hidden" name="_csrf" value="{{ csrf_token }}">

          {% if not table.isNew %}
            <input type="hidden" name="_method" value="PUT">
          {% endif %}

          <div class="form-group required">
            <label for="title" class="col-sm-3 control-label">{{ __('Table Name')}}</label>
            <div class="col-sm-9">
              <div class="input-group">
                <div class="input-group-addon">
                  <i class="fa fa-asterisk fa-fw"></i>
                </div>
                <input type="text" name="title" value="{{ table.title }}" placeholder="{{ __('Enter the name of your table')}}" class="form-control" id="title" required="true">
              </div>
            </div>
          </div>

<!--           <div class="form-group">
            <label for="password" class="col-sm-3 control-label">Password</label>
            <div class="col-sm-9">
              <div class="input-group">
                <div class="input-group-addon">
                  <i class="fa fa-lock fa-fw"></i>
                </div>
                <input type="text" name="password" value="{{ table.password }}" placeholder="Enter password or leave blank" class="form-control" id="password">
              </div>
            </div>
          </div> -->


          <div class="form-group required">
            <label for="setupName" class="col-sm-3 control-label">{{ __('Game Setup Name')}}</label>
            <div class="col-sm-9">
              <div class="input-group">
                <div class="input-group-addon">
                  <i class="fa fa-sitemap fa-fw"></i>
                </div>
                <input type="text" name="setupName" value="{{ table.setupName || table.setup.title }}" placeholder="{{ __('Enter the name of the game setup for this table')}}" class="form-control" id="setupName" required="true">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-3 control-label">{{ __('List in Public?')}}</label>
            <div class="col-sm-9">
              <div class="btn-group" data-toggle="buttons">
                <label href="#" for="isPrivate2" class="btn btn-xs btn-success {% if (!table.isPrivate) %} active {% endif %}">{{ __('public')}}
                  <input type="radio" id="isPrivate2" name="isPrivate" value="0" />
                </label>
                <label href="#" for="isPrivate1" class="btn btn-xs btn-warning {% if (table.isPrivate) %} active {% endif %}" >{{ __('private')}}
                  <input type="radio" id="isPrivate1" name="isPrivate" value="1" />
                </label>
              </div>
              <p class="help-block">{{ __('Private rooms are not listed, and can only be found by sharing the link (or guessing the room name)')}}.</p>
            </div>
          </div>


            <div class="form-group">
              <label for="rules" class="col-sm-3 control-label">{{ __('Rules')}}</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <div class="input-group-addon">
                    <i class="fa fa-institution fa-fw"></i>
                  </div>
                  <input type="text" name="rules" value="{{ table.rules }}" placeholder="{{ __('Enter custom rules link for this table, e.g.')}} http://myblog.com/rules..." class="form-control" id="rules">
                </div>
              </div>
            </div>


            {% if capture %}

                      <div class="panel panel-default col-sm-offset-3">
                        <div class="panel-heading">
                          <h4><a data-toggle="collapse" data-target="#accordionCapture">
                          <i class="fa fa-camera"></i>
                          {{ __('Capture from paper game')}}</a></h4>
                        </div>
                        <div class="panel-body collapse in" id="accordionCapture">
                          <video id="webcam" autoplay style="display:none;" width="1280" height="720"></video>
                          <canvas id="snapshot" class="fullscreen" width="1280" height="720"></canvas>
                          <div id="fps" class="info"></div>
                          <div>
                            <a id="captureBtn" class="btn btn-danger btn-lg" href="javascript:capture();">
                              {{ __('Capture design!')}} &nbsp;
                              <i class="fa fa-camera"></i>
                            </a>
                            <a id="retryBtn" class="btn btn-success btn-lg" href="javascript:retry();">
                              {{ __('Retry')}} &nbsp;
                              <i class="fa fa-undo"></i>
                            </a>
                          </div>
                          <div id="capturedElements">
                          </div>
                        </div>
                      </div>



                      <div class="panel panel-default col-sm-offset-3" id="mapcontainer">
                        <div class="panel-heading" id="mapareahead">
                          <h4>
                          <i class="fa fa-settings"></i>
                          {{ __('Board Map and Feedback')}}</h4>
                        </div>

                        <div class="panel-body" id="maparea">
                          <div class="row">
                            <div id="mapfb" class="col-sm-3 feedbacklist">
                                <ul class="list-group" id="fblist">
                                    <li class="list-group-item" id="fb0"> <strong>Feedback</strong> </li>
                                </ul>
                            </div>
                            <div id="mapboard">
                              <canvas id="boardcanvas" width="1412" height="875" style="border:1px solid #d3d3d3;">
                                Your browser does not support the HTML5 canvas tag.
                              </canvas>

                            </div>
                        </div>

                      </div>




                      <script>
                          var pieces = {% if setupPieces %}{{JSON.stringify(setupPieces)}}{% else %}[]{% endif %};
                          console.log("Pieces: "+JSON.stringify(pieces));
                          var table = {% if table %}{{JSON.stringify(table)}}{% else %}{}{% endif %};
                          console.log("Table: "+JSON.stringify(table));
                          var video = document.getElementById('webcam');
                          var canvas = document.getElementById('snapshot');
                          var ctx = canvas.getContext('2d');
                          var localMediaStream = null;

                          var continuous = true;

                          var lastTags;

                          //Elements to style for capture
                          var videoContBG = document.getElementById('snapshot');
                          var captureBtn = document.getElementById('captureBtn');
                          var retryBtn = document.getElementById('captureBtn');

                          var BOARD_TAGS = ["2","3","4","5"];
                          var CAPTURE_TAG = "0";
                          var AreaMap100 = {"capture":[[3.270803270803271,0],[20.105820105820104,14.075286415711947]],"context":[[3.751803751803752,18.821603927986907],[20.105820105820104,31.26022913256956]],"goals":[[3.751803751803752,35.3518821603928],[20.105820105820104,68.08510638297872]],"content":[[3.751803751803752,72.50409165302783],[20.105820105820104,104.9099836333879]],"c1-csw-technique":[[22.02982202982203,4.25531914893617],[40.4040404040404,23.895253682487724]],"c1-aba-css-task":[[22.02982202982203,24.713584288052374],[31.072631072631072,44.189852700490995]],"c1-aba-css-team":[[31.457431457431458,24.713584288052374],[40.4040404040404,44.189852700490995]],"c1-aba-css-tec1":[[22.02982202982203,44.84451718494272],[31.072631072631072,64.48445171849427]],"c1-aba-css-tec2":[[31.457431457431458,44.84451718494272],[40.4040404040404,64.48445171849427]],"c1-abb-css-task":[[22.02982202982203,65.13911620294598],[31.072631072631072,84.61538461538461]],"c1-abb-css-team":[[31.457431457431458,65.13911620294598],[40.4040404040404,84.61538461538461]],"c1-abb-css-tec1":[[22.02982202982203,85.27004909983633],[31.072631072631072,104.74631751227496]],"c1-abb-css-tec2":[[31.457431457431458,85.27004909983633],[40.4040404040404,104.74631751227496]],"c2-csw-technique":[[40.78884078884079,4.25531914893617],[59.06685906685907,23.895253682487724]],"c2-aba-css-task":[[40.78884078884079,24.713584288052374],[49.735449735449734,44.189852700490995]],"c2-aba-css-team":[[50.12025012025012,24.713584288052374],[59.06685906685907,44.189852700490995]],"c2-aba-css-tec1":[[40.78884078884079,44.84451718494272],[49.735449735449734,64.48445171849427]],"c2-aba-css-tec2":[[50.12025012025012,44.84451718494272],[59.06685906685907,64.48445171849427]],"c2-abb-css-task":[[40.78884078884079,65.13911620294598],[49.735449735449734,84.61538461538461]],"c2-abb-css-team":[[50.12025012025012,65.13911620294598],[59.06685906685907,84.61538461538461]],"c2-abb-css-tec1":[[40.78884078884079,85.27004909983633],[49.735449735449734,104.74631751227496]],"c2-abb-css-tec2":[[50.12025012025012,85.27004909983633],[59.06685906685907,104.74631751227496]],"c3-csw-technique":[[59.45165945165945,4.25531914893617],[77.82587782587782,23.895253682487724]],"c3-aba-css-task":[[59.45165945165945,24.713584288052374],[68.3982683982684,44.189852700490995]],"c3-aba-css-team":[[68.78306878306879,24.713584288052374],[77.82587782587782,44.189852700490995]],"c3-aba-css-tec1":[[59.45165945165945,44.84451718494272],[68.3982683982684,64.48445171849427]],"c3-aba-css-tec2":[[68.78306878306879,44.84451718494272],[77.82587782587782,64.48445171849427]],"c3-abb-css-task":[[59.45165945165945,65.13911620294598],[68.3982683982684,84.61538461538461]],"c3-abb-css-team":[[68.78306878306879,65.13911620294598],[77.82587782587782,84.61538461538461]],"c3-abb-css-tec1":[[59.45165945165945,85.27004909983633],[68.3982683982684,104.74631751227496]],"c3-abb-css-tec2":[[68.78306878306879,85.27004909983633],[77.82587782587782,104.74631751227496]],"c4-csw-technique":[[78.21067821067821,4.25531914893617],[96.48869648869649,23.895253682487724]],"c4-aba-css-task":[[78.21067821067821,24.713584288052374],[87.06108706108706,44.189852700490995]],"c4-aba-css-team":[[87.44588744588745,24.713584288052374],[96.48869648869649,44.189852700490995]],"c4-aba-css-tec1":[[78.21067821067821,44.84451718494272],[87.06108706108706,64.48445171849427]],"c4-aba-css-tec2":[[87.44588744588745,44.84451718494272],[96.48869648869649,64.48445171849427]],"c4-abb-css-task":[[78.21067821067821,65.13911620294598],[87.06108706108706,84.61538461538461]],"c4-abb-css-team":[[87.44588744588745,65.13911620294598],[96.48869648869649,84.61538461538461]],"c4-abb-css-tec1":[[78.21067821067821,85.27004909983633],[87.06108706108706,104.74631751227496]],"c4-abb-css-tec2":[[87.44588744588745,85.27004909983633],[96.48869648869649,104.74631751227496]]};


                          var width = canvas.width;
                          var height = canvas.height;

                          var fps = document.getElementById('fps');
                          var fpsText = document.createTextNode('');
                          fps.appendChild(fpsText);

                          //Takes an xml document, a field in the board and a value,
                          //and modifies the xmldoc accordingly
                          var modifyXMLField = function(xmlDoc,field,value,displaySuggest=true){
                              var QUESTIONTAG = "call-for-suggestion";
                              //var tech1 = xmlDoc.getElementById("1").getElementsByTagName("csw-technique")[0].getElementsByTagName("technique-name")[0];
                              //tech1.textContent = "?";
                              var col;
                              if(field.startsWith('c1')){
                                  col = xmlDoc.getElementById('1');
                              } else if(field.startsWith('c2')){
                                    col = xmlDoc.getElementById('2');
                              } else if(field.startsWith('c3')){
                                    col = xmlDoc.getElementById('3');
                              } else if(field.startsWith('c4')){
                                    col = xmlDoc.getElementById('4');
                              }

                              if(col){ //If it was a good column value, we dig further
                                  var restfield = field.substring(3);
                                  var fieldtag = col.getElementsByTagName(restfield)[0];
                                  // If the value is empty, we do nothing
                                  if(!value){
                                      //Do nothing
                                  }
                                  // If value is a ?, we add the special question tag (if displaySuggest=true)
                                  else if(value=="?"){
                                      if(displaySuggest){
                                          var qtag = xmlDoc.createElement(QUESTIONTAG);
                                          fieldtag.appendChild(qtag);
                                      }
                                  }
                                  // If it is a technique field, we have to split the value in two tags
                                  else if(restfield=="csw-technique"){
                                      var tagname = fieldtag.getElementsByTagName("technique-name")[0];
                                      tagname.textContent = value;
                                      //We add the phase tag
                                      var tagphase = fieldtag.getElementsByTagName("technique-phase")[0];
                                      if(value.indexOf("PHASE III")!=-1){ //It is a phase 3
                                          tagphase.textContent = "3";
                                      }else if(value.indexOf("PHASE II")!=-1){ //It is a phase 2
                                          tagphase.textContent = "2";
                                      }else if(value.indexOf("PHASE I")!=-1){ //It is a phase 1
                                          tagphase.textContent = "1";
                                      }
                                  }
                                  // If value is normal, just add the corresponding text
                                  else{
                                      fieldtag.textContent = value;
                                  }
                              }


                              return xmlDoc;
                          }


                          //returns the XML string corresponding to a query to the DB that mimics a board object passed
                          //displaySuggest indicates whether to include the ? card (not needed on certain KB calls)
                          var getXMLFromBoard = function(board, displaySuggest=true){
                              //get the base XML template
                              var emptyXML = '<?xml version="1.0"?><!DOCTYPE board SYSTEM "kb_in.dtd"><board><context>This is a text describing the context</context><goals><goal>This is a text describing a goal</goal><goal>This is a text describing another goal</goal></goals><content>This is a text describing some content</content><columns><column id="1"><csw-technique><technique-name/><technique-phase/></csw-technique><aba-css-task/><aba-css-team/><aba-css-tec1/><aba-css-tec2/><abb-css-task/><abb-css-team/><abb-css-tec1/><abb-css-tec2/></column><column id="2"><csw-technique><technique-name/><technique-phase/></csw-technique><aba-css-task/><aba-css-team/><aba-css-tec1/><aba-css-tec2/><abb-css-task/><abb-css-team/><abb-css-tec1/><abb-css-tec2/></column><column id="3"><csw-technique><technique-name/><technique-phase/></csw-technique><aba-css-task/><aba-css-team/><aba-css-tec1/><aba-css-tec2/><abb-css-task/><abb-css-team/><abb-css-tec1/><abb-css-tec2/></column><column id="4"><csw-technique><technique-name/><technique-phase/></csw-technique><aba-css-task/><aba-css-team/><aba-css-tec1/><aba-css-tec2/><abb-css-task/><abb-css-team/><abb-css-tec1/><abb-css-tec2/></column></columns></board>';
                              var parser = new DOMParser();
                              var xmlDoc = parser.parseFromString(emptyXML, "text/xml"); //important to use "text/xml"

                              //Modify the empty xml file with the board data
                              for(field in board){
                                  xmlDoc = modifyXMLField(xmlDoc,field,board[field],displaySuggest);
                              }

                              //var tech1 = xmlDoc.getElementById("1").getElementsByTagName("csw-technique")[0].getElementsByTagName("technique-name")[0];
                              //tech1.textContent = "?";

                              //Serialize the object to XML
                              var serializer = new XMLSerializer();
                              var xmlString = serializer.serializeToString(xmlDoc);
                              console.log(xmlString);
                              return xmlString;
                          }

                          //Finds y value of given object
                          var findPos = function(obj) {
                              var curtop = 0;
                              if (obj.offsetParent) {
                                  do {
                                      curtop += obj.offsetTop;
                                  } while (obj = obj.offsetParent);
                              return [curtop];
                              }
                          }


                          //Style elements taking into account the board tags present
                          var checkAndStyleBoardCapture = function(tags, videocont, button){
                              var board_present = 0;
                              for (tag in tags){
                                  if(BOARD_TAGS.indexOf(tag)!=-1){
                                      board_present++;
                                  }
                              }
                              if(board_present==4){ //All tags present, paint the frame with green border
                                  videocont.style.borderWidth = '20px';
                                  videocont.style.borderColor = 'green';
                                  videocont.style.borderStyle = 'solid';
                                  if(continuous) button.classList.remove("disabled");
                              }else if(board_present==0){ //No tags present, paint frame with red border and disable button
                                  videocont.style.borderWidth = '20px';
                                  videocont.style.borderColor = 'red';
                                  videocont.style.borderStyle = 'solid';
                                  if(continuous) button.classList.add("disabled");
                              }else if(board_present>0 && board_present<4){ //Some tags present, paint frame with yellow-orange border and disable button
                                  videocont.style.borderWidth = '20px';
                                  videocont.style.borderColor = 'orange';
                                  videocont.style.borderStyle = 'solid';
                                  if(continuous) button.classList.add("disabled");
                              }else{
                                  //Remove border and disable capture button, just in case
                                  videocont.style.borderStyle = 'none';
                                  if(continuous) button.classList.remove("disabled");
                              }
                              return board_present;
                          }

                          //gets a set of 4 pairs of numbers (tag corners x,y) and calculates the center
                          var getTagCenter = function(tag){
                            var center = [];
                            center = [(tag[0][0]+tag[1][0]+tag[2][0]+tag[3][0])/4, // x
                                      (tag[0][1]+tag[1][1]+tag[2][1]+tag[3][1])/4] // y
                            return center;
                          }

                          // do homography of corners and get which tags are where, see https://uncorkedstudios.com/blog/perspective-transforms-in-javascript
                          var getTransformedTags = function(tags, logging=false){
                              var transTagPos = {};
                              var srcCorners = [].concat.apply([],[ getTagCenter(tags['2']) ,
                                                                  getTagCenter(tags['3']) ,
                                                                  getTagCenter(tags['4']) ,
                                                                  getTagCenter(tags['5'])]); //Detected board tags
                              var dstCorners = [0,0,100,0,100,100,0,100]; //Ideal board (sides 0-100%)
                              var perspT = PerspT(srcCorners, dstCorners);
                              if(logging) console.log('Board detected at '+srcCorners);

                              var newCoords = {};
                              count = 0;
                              for(tag in tags){
                                  if($.inArray(tag, BOARD_TAGS)==-1){ //We check only non-board tags
                                      var srcPt = getTagCenter(tags[tag]);
                                      var dstPt = perspT.transform(srcPt[0], srcPt[1]);
                                      newCoords[tag] = dstPt;
                                      count++;
                                  }
                              }
                              if(logging) console.log('Found '+count+' non-board tags: '+JSON.stringify(newCoords));
                              return newCoords;
                          }


                          //Get the board regions and which cards are in them, and returns that javascript object
                          var getBoardRegions = function(transTagPositions, AreaMap100){
                            //Clone the object
                            tagsBoard = $.extend(true, {}, AreaMap100);
                            tagsBoard.noarea = []; //For tags in the board but outside the delimited areas (will flag up in syntactic check)

                            // Go through the tags, and see if they are in any of the areas
                            for(tag in transTagPositions){ //go through the detected tags...
                                tagcoords = transTagPositions[tag];
                                var found = false;
                                for(area in tagsBoard){ // For every area...
                                    if(area != "noarea"){
                                      var coords = tagsBoard[area];
                                      if(tagcoords[0]>coords[0][0] && tagcoords[0]<coords[1][0] &&
                                        tagcoords[1]>coords[0][1] && tagcoords[1]<coords[1][1]){ // The tag is in this area
                                            tagsBoard[area] = tag; //We set the area value to the tag nr
                                            found = true;
                                        }
                                    }
                                }
                                // Once we go through all areas, if the tag was in none, we add it to the noarea field
                                if(!found){
                                    tagsBoard.noarea.push(tag);
                                }
                            }
                            // We check that all the boards got a tag or an empty string
                            for(area in tagsBoard){
                                if(area != "noarea" && typeof tagsBoard[area] != "string"){
                                    tagsBoard[area]="";
                                }
                            }

                            //Alternative:
                            //Go through the areas and see if there is any of the tags inside
                            // for(area in tagsBoard){ // For every area...
                            //     var coords = tagsBoard[area];
                            //     for(tag in transTagPositions){ //go through the detected tags...
                            //         tagcoords = transTagPositions[tag];
                            //         if(tagcoords[0]>coords[0][0] && tagcoords[0]<coords[1][0] &&
                            //           tagcoords[1]>coords[0][1] && tagcoords[1]<coords[1][1]){ // The tag is in this area
                            //               tagsBoard[area] = tag; //We set the area value to the tag nr
                            //           }
                            //     }
                            //     //If the value of the area is not a string, we did not find any tag in this area, we set it to empty
                            //     if(typeof tagsBoard[area] != "string"){
                            //         tagsBoard[area] = "";
                            //     }
                            //
                            // }

                            //Return the object
                            return tagsBoard;
                          }


                          //Checking camera
                          var hasGetUserMedia = function() {
                              return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
                                      navigator.mozGetUserMedia || navigator.msGetUserMedia);
                          }
                          //Error
                          var onFailSoHard = function(e) {
                              console.log('Error!', e);
                          };

                          //Camera capture
                          var snapshot = function() {
                              if (localMediaStream) {
                                  ctx.drawImage(video, 0, 0, video.width, video.height);
                                  var start = new Date();
                                  var obj = Chilitags.findTagsOnImage(canvas, true);
                                  lastTags = obj;
                                  var end = new Date();
                                  var str = 'tag: ';
                                  for(var tag in obj){
                                      str += tag + ", ";
                                  }
                                  fpsText.nodeValue = video.width+"x"+video.height+"--Chilitags processing = " + (end.getTime() - start.getTime()) + "ms  " + str;
                              }
                              // We color the video's containters bg color, and disable the capture button,
                              // so that we can know when the capture is possible
                              var board_present = checkAndStyleBoardCapture(lastTags, videoContBG, captureBtn);
                              if(board_present==4){
                                // do homography of corners and get which tags are where, see https://uncorkedstudios.com/blog/perspective-transforms-in-javascript
                                transTagPositions = getTransformedTags(lastTags);
                                if(transTagPositions[CAPTURE_TAG] && transTagPositions[CAPTURE_TAG][0]>AreaMap100['capture'][0][0] &&
                                          transTagPositions[CAPTURE_TAG][0]<AreaMap100['capture'][1][0] &&
                                          transTagPositions[CAPTURE_TAG][1]>AreaMap100['capture'][0][1] &&
                                          transTagPositions[CAPTURE_TAG][1]<AreaMap100['capture'][1][1]){
                                    // if the capture card is inside the capture area, we call capture()
                                    capture();
                                }
                              }
                              if(continuous) requestAnimationFrame(snapshot);
                          }


                          //Gets the captured board with cards, and checks if they breach
                          //any of the game's syntax rules.
                          //Returns an array of error messages to be displayed
                          var doSyntaxChecks = function(cardRegions,pieces){
                            var errors = [];
                            //TODO!
                            return errors;

                          }

                          //Converts an object with regions and the associated Chilitags
                          //To a similar object with the card titles instead, for later XML generation
                          var lookupCardRegions = function(cardRegions,pieces){
                              var board = {};
                              for(vars in cardRegions){
                                  var cardsInRegion = cardRegions[vars];
                                  if(!cardsInRegion){
                                      board[vars] = "";
                                  }else{
                                      if(typeof cardsInRegion == "string"){
                                          var result = $.grep(pieces, function(e){  if(e.chilitags && e.chilitags[0]){
                                                                                      return (e.chilitags[0] == parseInt(cardsInRegion,10));
                                                                                    }else{
                                                                                      return false;
                                                                                    };});
                                          if(result.length>=1){//we found a card with that chilitag
                                              console.log('found one');
                                              var res = result[0];
                                              board[vars] = res.title.substring(0,res.title.lastIndexOf(' ',res.title.lastIndexOf(' ')-1));
                                          }else{
                                              board[vars] = "";
                                          }

                                      }else{ //it's and object i.e. an array
                                          for(var i = 0;i<cardsInRegion.length;i++){
                                              var card = cardsInRegion[i];
                                              var result = $.grep(pieces, function(e){  if(e.chilitags && e.chilitags[0]){
                                                                                          return (e.chilitags[0] == parseInt(card,10));
                                                                                        }else{
                                                                                          return false;
                                                                                        };});
                                              if(result.length>=1){//we found a card with that chilitag
                                                  console.log('found one');
                                                  var res = result[0];
                                                  board[vars] = res.title.substring(0,res.title.lastIndexOf(' ',res.title.lastIndexOf(' ')-1)); //TODO: eliminate the part of the title with tag number and language
                                              }else{
                                                  board[vars] = "";
                                              }
                                          }
                                      }

                                  }
                              }
                              console.log('Looked up card regions:\n'+JSON.stringify(board));
                              return board;
                          }


                          //Gets a xmlBoard in a string, and POSTs it (directly or through our server)
                          //to the KB, redirecting the response to a callback and putting a loading icon
                          var doSemanticChecks = function(xmlstring){
                              //TODO!
                              console.log('Will be sending this file to the KB:\n'+xmlstring);

                          }

                          var displaySyntaxErrors = function(errors){
                              if(errors.length==0){
                                  //We display a no errors found message
                                  $('#fblist').empty();
                                  $('#fblist').append('<li class="list-group-item" id="fb0"> <strong>Feedback</strong> </li>');
                                  $('#fblist').append('<li class="list-group-item" id="fb1"> <i class="fa fa-check"></i> The board appears to be syntactically correct! </li>');
                              }else{
                                  //TODO: Generate and place the error messages

                              }
                          }


                          //This function is triggered by the capture button/card. Performs all the corresponding checks
                          //and stores the board in DB
                          var capture = function() {
                              continuous=false;
                              var str = JSON.stringify(lastTags);
                              var captured = document.getElementById('capturedElements');
                              var capturedText = document.createTextNode(str);
                              captured.appendChild(capturedText);
                              captureBtn.classList.add("disabled");

                              var board_present = checkAndStyleBoardCapture(lastTags, videoContBG, captureBtn);
                              if(board_present==4){
                                  // do homography of corners and get which tags are where, see https://uncorkedstudios.com/blog/perspective-transforms-in-javascript
                                  var transTagPositions = getTransformedTags(lastTags, true); //activate console logging
                                  var cardRegions = getBoardRegions(transTagPositions, AreaMap100);
                                  var errors=[];
                                  errors = doSyntaxChecks(cardRegions,pieces);
                                  displaySyntaxErrors(errors);
                                  if(errors.length==0){
                                      var capturedBoard = lookupCardRegions(cardRegions,pieces);
                                      var xmlBoard = getXMLFromBoard(capturedBoard);
                                      doSemanticChecks(xmlBoard); //TODO: should probably have some kind of callback to the next part of the code
                                  }
                                  //TODO: save board as a table into the database
                                  //scroll to the board map and feedback
                                  //$('mapareahead').collapse('show'); //For now, the map is always visible
                                  drawBoard();
                                  drawCards(transTagPositions, pieces, 1412, 875);
                                  window.scroll(0,findPos(document.getElementById("mapcontainer")));
                              }

                          }

                          var retry = function() {
                              continuous=true;
                              var captured = document.getElementById('capturedElements');
                              var capturedText = document.createTextNode('');
                              //captured.removeChild(captured.firstChild);
                              captured.innerHTML='';
                              captured.appendChild(capturedText);
                              captureBtn.classList.add("disabled");
                              requestAnimationFrame(snapshot);
                          }

                          var drawCards = function(tags100, allpieces, width, height){
                              var c = document.getElementById("boardcanvas");
                              var ctx = c.getContext("2d");
                              for(tag in tags100){
                                  if(tags100[tag][0]>0 &
                                      tags100[tag][0]<100 &
                                      tags100[tag][1]>0 &
                                      tags100[tag][1]<100){ // We draw only the cards INSIDE the four board tags -- that are not contesto, objettivi, contenuto!
                                        console.log('found tag '+tag+' at position '+tags100[tag]);
                                        var cardimg = new Image();
                                        cardimg.id = "cardimg"+(new Date()).getTime();
                                        piece = {};
                                        for(var i = 0; i < pieces.length; i++){
                                            var tmppiece = allpieces[i];
                                            if(tmppiece['chilitags'][0]==tag){
                                                piece = tmppiece;
                                                break;
                                            }
                                        }
                                        var cardUri = piece['image']['cdnUri']+'/original_'+piece['image']['files'][0];
                                        console.log("Trying to draw "+cardUri);
                                        cardimg.src = cardUri;
                                        ctx.drawImage(cardimg, 0, 0);//TODO: modify x, y AND PRELOAD ALL IMAGES!!?
                                  }
                              }



                          }

                          var drawBoard = function(){
                              var c = document.getElementById("boardcanvas");
                              var ctx = c.getContext("2d");
                              var boardimg = new Image();
                              boardimg.id = "boardimg";
                              //Look for the board piece _id  57f58b985dcddd50009e8b1a or lockable true
                              boardpiece = {};
                              for(var i = 0; i < pieces.length; i++){
                                  piece = pieces[i];
                                  if(piece['_id']=='57f58b985dcddd50009e8b1a'){
                                      boardpiece = piece;
                                      break;
                                  }
                              }
                              var boardUri = boardpiece['image']['cdnUri']+'/original_'+boardpiece['image']['files'][0];
                              console.log("Trying to draw "+boardUri);
                              boardimg.src = boardUri;
                              ctx.drawImage(boardimg, 0, 0);
                          }

                          if (hasGetUserMedia()) {
                              console.log("Camera OK");
                          } else {
                              alert("Invalid!");
                          }

                          drawBoard();

                          window.URL = window.URL || window.webkitURL;
                          navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia || navigator.msGetUserMedia;

                          navigator.getUserMedia({video: //true
                             {
                               optional: [
                                 {minWidth: 320},
                                 {minWidth: 640},
                                 {minWidth: 1024},
                                 {minWidth: 1280},
                            //     {minWidth: 1920},
                            //     {minWidth: 2560},
                               ]
                             }
                          }, function(stream) {
                                  video.src = window.URL.createObjectURL(stream);
                                  localMediaStream = stream;
                                  video.play();
                                  }, onFailSoHard);

                          video.addEventListener('play', function() {setTimeout('snapshot()', 2500);}, false);

                      </script>





            {% endif %}



          <div class="panel panel-default col-sm-offset-3">
            <div class="panel-heading">
              <h4><a data-toggle="collapse" data-target="#accordion">
              <i class="fa fa-settings"></i>
              {{ __('Advanced Options')}}</a></h4>
            </div>

            <div class="panel-body collapse" id="accordion">



              <div class="form-group">
                <label class="col-sm-3 control-label">{{ __('Use WebRTC Video')}}</label>
                <div class="col-sm-9">
                  <div class="btn-group" data-toggle="buttons">
                    <label href="#" for="rtcVideo1" class="btn btn-xs btn-default active" >{{ __('yes')}}
                      <input type="radio" id="rtcVideo1" name="rtcVideo" value="1" />
                    </label>
                    <label href="#" for="rtcVideo2" class="btn btn-xs btn-default">{{ __('no')}}
                      <input type="radio" id="rtcVideo2" name="rtcVideo" value="0" />
                    </label>
                  </div>
                  <p class="help-block">{{ __('Use built-in WebRTC peer to peer video chat')}}.</p>
                </div>
              </div>



              <div class="form-group">
                <label class="col-sm-3 control-label">{{ __('Use WebRTC Audio')}}</label>
                <div class="col-sm-9">
                  <div class="btn-group" data-toggle="buttons">
                    <label href="#" for="rtcAudio1" class="btn btn-xs btn-default active" >{{ __('yes')}}
                      <input type="radio" id="rtcAudio1" name="rtcAudio" value="1" />
                    </label>
                    <label href="#" for="rtcAudio2" class="btn btn-xs btn-default">{{ __('no')}}
                      <input type="radio" id="rtcAudio2" name="rtcAudio" value="0" />
                    </label>
                  </div>
                  <p class="help-block">{{ __('Use built-in WebRTC peer to peer audio chat')}}.</p>
                </div>
              </div>


            <div class="form-group">
              <label for="phone" class="col-sm-3 control-label"> {{ __('Phone Conference Number')}} </label>
              <div class="col-sm-9">
                <div class="input-group">
                  <div class="input-group-addon">
                    <i class="fa fa-phone fa-fw"></i>
                  </div>
                  <input type="text" name="phone" value="{{ table.phone }}" placeholder="{{ __('Enter the conference phone number for this table, e.g.')}} +1 123 1234 123" class="form-control" id="phone">
                </div>
              </div>
            </div>


            <div class="form-group">
              <label for="skype" class="col-sm-3 control-label">{{ __('Skype Group Link')}}</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <div class="input-group-addon">
                    <i class="fa fa-skype fa-fw"></i>
                  </div>
                  <input type="text" name="skype" value="{{ table.skype }}" placeholder="{{ __('Enter a skype group link for this table, e.g.')}} skype:?chat&blob=d6e5AV..." class="form-control" id="skype">
                </div>
                <p class="help-block"><a href="http://blogs.skype.com/2013/03/08/managing-your-group-chats-like-a-boss/" target="_blank">{{ __('Create')}}</a> {{ __('a skype group link')}}</p>
              </div>
            </div>



            <div class="form-group">
              <label for="tags" class="col-sm-3 control-label">{{ __('Tags')}}</label>
              <div class="col-sm-9">
                <input type="text" name="tags" value="{{ table.tags }}" placeholder="{{ __('Enter the tags separated by , ')}}" class="form-control" id="tags">
                <small>{{ __('separate tags by ,')}}</small>
              </div>
            </div>
          </div>
            </div>

          <div class="form-group">
            <div class="col-sm-offset-3 col-sm-9">
              <button class="btn btn-primary" type="submit">{{ __('Create')}}</button>
              &nbsp;
              <a href="/tables" class="btn btn-link">{{ __('Cancel')}}</a>
            </div>
          </div>
        </form>
      </div>

    </div>
  </section>

<div class="about"></div>


{% endblock %}
